{% extends "base.html" %}
{% block title %}Timeline – StructureHub{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="mb-0">Timeline</h1>
</div>

<!-- Location filter -->
<div class="btn-group mb-3" role="group" aria-label="Location">
  <a class="btn btn-outline-secondary" data-loc="" href="{% url 'monitor:timeline' %}">All</a>
  <a class="btn btn-outline-secondary" data-loc="0" href="{% url 'monitor:timeline' %}?loc=0">Attic</a>
  <a class="btn btn-outline-secondary" data-loc="1" href="{% url 'monitor:timeline' %}?loc=1">Crawlspace</a>
  <a class="btn btn-outline-secondary" data-loc="2" href="{% url 'monitor:timeline' %}?loc=2">Basement</a>
  <a class="btn btn-outline-secondary" data-loc="3" href="{% url 'monitor:timeline' %}?loc=3">Other</a>
</div>

<div class="btn-group mb-3" role="group" aria-label="Range">
  <button class="btn btn-outline-secondary" data-range="1h">1h</button>
  <button class="btn btn-outline-secondary active" data-range="6h">6h</button>
  <button class="btn btn-outline-secondary" data-range="24h">24h</button>
  <button class="btn btn-outline-secondary" data-range="7d">7d</button>
</div>

<!-- Temperature graph -->
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Temperature (°F)</h5>
      <small class="text-muted" id="metaTemp">Loading…</small>
    </div>
    <div style="height: 280px;">
      <canvas id="tempChart"></canvas>
    </div>
  </div>
</div>

<!-- Humidity graph -->
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Humidity (%)</h5>
      <small class="text-muted" id="metaHum">Loading…</small>
    </div>
    <div style="height: 280px;">
      <canvas id="humChart"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

<script>
let tempChart = null;
let humChart  = null;
let currentRange = "6h";

function getLoc() {
  return new URLSearchParams(window.location.search).get("loc") || "";
}

function setLocationButtons() {
  const loc = getLoc();
  document.querySelectorAll("[data-loc]").forEach(a => {
    a.classList.toggle("active", (a.getAttribute("data-loc") || "") === loc);
  });
}

function setActive(range) {
  document.querySelectorAll("button[data-range]").forEach(b => {
    b.classList.toggle("active", b.dataset.range === range);
  });
}

function mkLineChart(canvasId, label, yTitle) {
  return new Chart(document.getElementById(canvasId), {
    type: "line",
    data: { labels: [], datasets: [{ label, data: [], tension: 0.2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { type: "time" },
        y: { title: { display: true, text: yTitle } }
      },
      plugins: {
        legend: { display: true }
      }
    }
  });
}

async function loadTimeline(range) {
  currentRange = range;
  setActive(range);

  const loc = getLoc();
  const locPart = loc ? `&loc=${encodeURIComponent(loc)}` : "";
  const res = await fetch(`/api/history.json?range=${encodeURIComponent(range)}${locPart}`);
  const payload = await res.json();
  const rows = payload.data || [];

  // Meta
  const locLabel = loc ? ` • loc ${loc}` : " • all locations";
  const metaText = `${payload.count} points • range ${payload.range}${locLabel}`;
  document.getElementById("metaTemp").innerText = metaText;
  document.getElementById("metaHum").innerText  = metaText;

  // Build series
  const labels = rows.map(r => new Date(r.ts));
  const tempF  = rows.map(r => r.temp_f);
  const humPct = rows.map(r => r.hum_pct);

  // Temp chart
  if (!tempChart) {
    tempChart = new Chart(document.getElementById("tempChart"), {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Temp (°F)",
          data: [],
          tension: 0.2,
          borderColor: "rgb(220, 53, 69)",
          backgroundColor: "rgba(220, 53, 69, 0.15)",
          pointRadius: 2,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { type: "time" },
          y: { title: { display: true, text: "°F" } }
        },
        plugins: { legend: { display: true } }
      }
    });
  }
  tempChart.data.labels = labels;
  tempChart.data.datasets[0].data = tempF;
  tempChart.update();

  // Hum chart
  if (!humChart) {
    humChart = mkLineChart("humChart", "RH (%)", "%");
  }
  humChart.data.labels = labels;
  humChart.data.datasets[0].data = humPct;
  humChart.update();
}

document.querySelectorAll("button[data-range]").forEach(btn => {
  btn.addEventListener("click", () => loadTimeline(btn.dataset.range));
});

setLocationButtons();
loadTimeline(currentRange);
</script>
{% endblock %}
