{% extends "base.html" %}
{% block title %}Live – StructureHub{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="mb-0">Live</h1>
</div>

<!-- Location filter -->
<div class="btn-group mb-3" role="group" aria-label="Location">
  <a class="btn btn-outline-secondary" data-loc="" href="{% url 'monitor:live' %}">All</a>
  <a class="btn btn-outline-secondary" data-loc="0" href="{% url 'monitor:live' %}?loc=0">Attic</a>
  <a class="btn btn-outline-secondary" data-loc="1" href="{% url 'monitor:live' %}?loc=1">Crawlspace</a>
  <a class="btn btn-outline-secondary" data-loc="2" href="{% url 'monitor:live' %}?loc=2">Basement</a>
  <a class="btn btn-outline-secondary" data-loc="3" href="{% url 'monitor:live' %}?loc=3">Other</a>
</div>

<div id="status" class="alert alert-secondary">Waiting for data…</div>

<div class="row g-3 mb-3">
  <div class="col-lg-3 col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="text-muted small">Temperature</div>
        <div class="display-6" id="temp">--</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="text-muted small">Humidity</div>
        <div class="display-6" id="hum">--</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="text-muted small">Pressure</div>
        <div class="display-6" id="press">--</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="text-muted small mb-2">Sensor Battery</div>

        <div class="d-flex align-items-center gap-3">
          <svg id="batterySvg" width="150" height="60" viewBox="0 0 150 60" role="img" aria-label="Battery">
            <rect x="2" y="10" width="124" height="34" rx="6" ry="6"
                  fill="white" stroke="#333" stroke-width="2"/>
            <rect x="128" y="20" width="14" height="14" rx="3" ry="3"
                  fill="#333"/>

            <clipPath id="batteryClip">
              <rect id="batteryFillClip" x="4" y="12" width="0" height="30" rx="5" ry="5"/>
            </clipPath>

            <rect id="batteryFillRect" x="4" y="12" width="120" height="30" rx="5" ry="5"
                  fill="#4caf50" clip-path="url(#batteryClip)"/>

            <text id="batteryPctText" x="64" y="33"
                  text-anchor="middle" font-size="14" font-family="system-ui, sans-serif" fill="#111">
              --%
            </text>

            <text id="batteryVoltText" x="64" y="54"
                  text-anchor="middle" font-size="12" font-family="system-ui, sans-serif" fill="#555">
              -- V
            </text>
          </svg>

          <div class="small text-muted">
            <div><strong id="battMetaTitle">Battery</strong></div>
            <div id="battMeta">waiting…</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Dew Risk + Motion Status (50/50 on large screens) -->
<div class="row g-3 mb-3">
  <!-- Moisture / Dew card -->
  <div class="col-12 col-lg-6">
    <div id="riskCard" class="card border-start border-4 border-success h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="text-muted small">Attic Moisture Risk</div>
            <div class="h5 mb-0" id="riskLabel">--</div>
          </div>
          <span id="riskPill" class="badge text-bg-success">LOW</span>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="text-muted small">Dew Point</div>
            <div class="display-6" id="dewPoint">--</div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Spread (Temp − Dew Point)</div>
            <div class="display-6" id="spread">--</div>
          </div>
        </div>

        <div class="small text-muted mt-2">
          Dew point is when attic air condenses on cooler surfaces (roof deck, nails, ducts). Lower spread = higher risk.
        </div>

        <div class="small mt-2">
          <span class="me-3"><span class="badge text-bg-success">Low</span> ≥ 10°F</span>
          <span class="me-3"><span class="badge text-bg-warning">Medium</span> 5–10°F</span>
          <span class="me-3"><span class="badge text-bg-danger">High</span> &lt; 5°F</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Motion card -->
  <div class="col-12 col-lg-6">
    <div id="motionCard" class="card border-start border-4 border-success h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="text-muted small">Motion Status</div>
            <div class="h5 mb-0" id="motionLabel">--</div>
          </div>
          <span id="motionPill" class="badge text-bg-success">QUIET</span>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="text-muted small">Last Motion</div>
            <div class="fs-4 fw-bold" id="motionWhen">--</div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Age</div>
            <div class="fs-4 fw-bold" id="motionAge">--</div>
          </div>
        </div>

        <div class="small text-muted mt-2">
          Motion can indicate animals/pests, human entry, or unusual activity. “Motion” is based on the most recent change
          in motion counters reported by your sensor.
        </div>

        <div class="small mt-2">
          <span class="me-3"><span class="badge text-bg-success">Quiet</span> &gt; 15 min</span>
          <span class="me-3"><span class="badge text-bg-warning">Recent</span> 2–15 min</span>
          <span class="me-3"><span class="badge text-bg-danger">Motion</span> &lt; 2 min</span>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- System Intelligence Summary -->
<div class="card mb-3" id="intelCard">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <div class="text-muted small">System Intelligence</div>
        <div class="h5 mb-0" id="intelTitle">Overall Risk: --</div>
      </div>
      <span id="intelPill" class="badge text-bg-secondary">--</span>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <div class="text-muted small">Trend (Temp)</div>
        <div class="fs-5 fw-semibold" id="trendTemp">--</div>
      </div>
      <div class="col-md-4">
        <div class="text-muted small">Trend (Humidity)</div>
        <div class="fs-5 fw-semibold" id="trendHum">--</div>
      </div>
      <div class="col-md-4">
        <div class="text-muted small">Data Quality</div>
        <div class="fs-5 fw-semibold" id="dataQuality">--</div>
      </div>
    </div>

    <div class="mt-3">
      <div class="text-muted small mb-1">Recommendations</div>
      <ul class="mb-0" id="intelRecs"></ul>
    </div>
  </div>
</div>


<div class="card">
  <div class="card-body">
    <div class="row g-3 small">
      <div class="col-md-3"><span class="text-muted">Last Update:</span> <span id="ts">--</span></div>
      <div class="col-md-2"><span class="text-muted">Seq:</span> <span id="seq">--</span></div>
      <div class="col-md-2"><span class="text-muted">RSSI:</span> <span id="rssi">--</span></div>
      <div class="col-md-5"><span class="text-muted">Source:</span> <span id="source">--</span></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function setStatus(ok, text, level) {
  const el = document.getElementById("status");
  el.className = "alert " + (level || "alert-secondary");
  el.textContent = text;
}

function fmtLocal(iso) {
  return new Date(iso).toLocaleString();
}

function fmtAge(sec) {
  if (sec == null) return "--";
  sec = Math.max(0, Number(sec));
  if (sec < 60) return `${Math.round(sec)} sec`;
  const m = Math.floor(sec / 60);
  if (m < 60) return `${m} min`;
  const h = Math.floor(m / 60);
  return `${h} hr`;
}

function setBattery(pct, volts) {
  const pctText  = document.getElementById("batteryPctText");
  const voltText = document.getElementById("batteryVoltText");
  const clip     = document.getElementById("batteryFillClip");
  const fillRect = document.getElementById("batteryFillRect");
  const meta     = document.getElementById("battMeta");

  if (pct == null || volts == null) {
    pctText.textContent = "--%";
    voltText.textContent = "-- V";
    clip.setAttribute("width", "0");
    fillRect.setAttribute("fill", "#9e9e9e");
    meta.textContent = "no data";
    return;
  }

  const fillW = Math.round(120 * (pct / 100.0));
  clip.setAttribute("width", String(fillW));

  let color = "#4caf50";
  if (pct <= 15) color = "#f44336";
  else if (pct <= 35) color = "#ff9800";
  fillRect.setAttribute("fill", color);

  pctText.textContent = `${pct}%`;
  voltText.textContent = `${Number(volts).toFixed(2)} V`;
  meta.textContent = `${pct}% • ${Number(volts).toFixed(2)} V`;
}

function setRiskCard(r) {
  const dpF = r.dew_point_f;
  const spreadF = r.spread_f;

  document.getElementById("dewPoint").textContent =
    (dpF == null) ? "--" : (Number(dpF).toFixed(1) + "°F");

  document.getElementById("spread").textContent =
    (spreadF == null) ? "--" : (Number(spreadF).toFixed(1) + "°F");

  const riskCard = document.getElementById("riskCard");
  const riskPill = document.getElementById("riskPill");
  const riskLabel = document.getElementById("riskLabel");

  const level = (r.risk_level || "low").toLowerCase();
  const label = (r.risk_label || "LOW").toUpperCase();
  riskLabel.textContent = label;
  riskPill.textContent = label;

  riskCard.className = "card border-start border-4 h-100";
  riskPill.className = "badge";

  if (level === "high") {
    riskCard.classList.add("border-danger");
    riskPill.classList.add("text-bg-danger");
  } else if (level === "med") {
    riskCard.classList.add("border-warning");
    riskPill.classList.add("text-bg-warning");
  } else {
    riskCard.classList.add("border-success");
    riskPill.classList.add("text-bg-success");
  }
}

function setMotionCard(r) {
  const motionCard = document.getElementById("motionCard");
  const motionPill = document.getElementById("motionPill");
  const motionLabel = document.getElementById("motionLabel");
  const motionWhen = document.getElementById("motionWhen");
  const motionAge  = document.getElementById("motionAge");

  const level = (r.motion_level || "low").toLowerCase();   // low/med/high
  const label = (r.motion_label || "QUIET").toUpperCase(); // QUIET/RECENT/MOTION

  motionLabel.textContent = label;
  motionPill.textContent = label;

  const ts = r.last_motion_ts;
  motionWhen.textContent = ts ? fmtLocal(ts) : "--";
  motionAge.textContent = fmtAge(r.last_motion_age_sec);

  motionCard.className = "card border-start border-4 h-100";
  motionPill.className = "badge";

  if (level === "high") {
    motionCard.classList.add("border-danger");
    motionPill.classList.add("text-bg-danger");
  } else if (level === "med") {
    motionCard.classList.add("border-warning");
    motionPill.classList.add("text-bg-warning");
  } else {
    motionCard.classList.add("border-success");
    motionPill.classList.add("text-bg-success");
  }
}

function setLocationButtons() {
  const loc = new URLSearchParams(window.location.search).get("loc") || "";
  document.querySelectorAll("[data-loc]").forEach(a => {
    a.classList.toggle("active", (a.getAttribute("data-loc") || "") === loc);
  });
}

async function tick() {
  const loc = new URLSearchParams(window.location.search).get("loc");
  const url = loc ? ("/api/last?loc=" + encodeURIComponent(loc)) : "/api/last";
  const r = await fetch(url).then(x => x.json()).catch(() => null);

  if (!r || !r.valid) {
    setStatus(false, "No data yet", "alert-warning");
    return;
  }

  const ageSec = (Date.now() - new Date(r.ts).getTime()) / 1000.0;
  const stale = ageSec > 10;

  if (stale) {
    setStatus(true, `Stale (${Math.round(ageSec)}s old)`, "alert-danger");
    document.getElementById("batterySvg").style.opacity = "0.45";
  } else {
    setStatus(true, "Live", "alert-success");
    document.getElementById("batterySvg").style.opacity = "1.0";
  }

  const tempF = (r.temp_c * 9/5 + 32);
  document.getElementById("temp").textContent = tempF.toFixed(1) + "°F";
  document.getElementById("hum").textContent = Number(r.hum_pct).toFixed(0) + "%";
  document.getElementById("press").textContent = Number(r.press_hpa).toFixed(1) + " hPa";

  document.getElementById("ts").textContent = fmtLocal(r.ts);
  document.getElementById("seq").textContent = r.seq ?? "--";
  document.getElementById("rssi").textContent = r.rssi ?? "--";
  document.getElementById("source").textContent = r.source || "--";

  setBattery(r.batt_pct, r.batt_v);
  setRiskCard(r);
  setMotionCard(r);
}

async function loadIntelSummary() {
  const loc = new URLSearchParams(window.location.search).get("loc") || "";
  const locPart = loc !== "" ? ("?loc=" + encodeURIComponent(loc)) : "";
  const url = "/api/summary.json" + locPart + (locPart ? "&" : "?") + "window=24";

  const s = await fetch(url).then(r => r.json()).catch(() => null);
  if (!s || !s.valid) return;

  const lvl = (s.risk?.overall_level || "unknown").toLowerCase();
  const pill = document.getElementById("intelPill");
  const card = document.getElementById("intelCard");

  const label = lvl.toUpperCase();
  document.getElementById("intelTitle").textContent = "Overall Risk: " + label;
  pill.textContent = label;

  pill.className = "badge";
  card.className = "card mb-3";

  if (lvl === "high") pill.classList.add("text-bg-danger");
  else if (lvl === "med") pill.classList.add("text-bg-warning");
  else if (lvl === "low") pill.classList.add("text-bg-success");
  else pill.classList.add("text-bg-secondary");

  const tSlope = s.trends?.temp_f_slope_per_hr;
  const hSlope = s.trends?.hum_slope_per_hr;

  document.getElementById("trendTemp").textContent =
    (tSlope == null) ? "--" : ((tSlope >= 0 ? "+" : "") + tSlope.toFixed(2) + " °F/hr");

  document.getElementById("trendHum").textContent =
    (hSlope == null) ? "--" : ((hSlope >= 0 ? "+" : "") + hSlope.toFixed(2) + " %/hr");

  const anoms = s.anomalies || [];
  const stale = s.risk?.stale;
  const dq = stale ? "STALE" : (anoms.length ? ("Anomalies: " + anoms.length) : "OK");
  document.getElementById("dataQuality").textContent = dq;

  const ul = document.getElementById("intelRecs");
  ul.innerHTML = "";
  (s.recommendations || []).forEach(txt => {
    const li = document.createElement("li");
    li.textContent = txt;
    ul.appendChild(li);
  });
}

// call it once at startup, then every 30s (no need to do it every second)
loadIntelSummary();
setInterval(loadIntelSummary, 30000);


setLocationButtons();
tick();
setInterval(tick, 1000);
</script>
{% endblock %}
