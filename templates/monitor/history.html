{% extends "base.html" %}
{% block title %}History – StructureHub{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="mb-0">History</h1>
    <div class="text-muted">
      {% if loc is not None %}Filtered: {{ loc_label }}{% else %}All locations{% endif %}
    </div>
  </div>
</div>

<div class="btn-group mb-3" role="group" aria-label="Location filter">
  <a class="btn btn-outline-secondary {% if loc is None %}active{% endif %}"
     href="{% url 'monitor:history' %}">All</a>
  <a class="btn btn-outline-secondary {% if loc == 0 %}active{% endif %}"
     href="{% url 'monitor:history' %}?loc=0">Attic</a>
  <a class="btn btn-outline-secondary {% if loc == 1 %}active{% endif %}"
     href="{% url 'monitor:history' %}?loc=1">Crawlspace</a>
  <a class="btn btn-outline-secondary {% if loc == 2 %}active{% endif %}"
     href="{% url 'monitor:history' %}?loc=2">Basement</a>
  <a class="btn btn-outline-secondary {% if loc == 3 %}active{% endif %}"
     href="{% url 'monitor:history' %}?loc=3">Other</a>
</div>

<div class="card">
  <div class="card-body">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-muted">
        {% if page_obj.paginator.count %}
          Showing {{ page_obj.start_index }}–{{ page_obj.end_index }}
          of {{ page_obj.paginator.count }}
        {% else %}
          No readings yet
        {% endif %}
      </div>

      <div class="d-flex align-items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="btn btn-outline-secondary btn-sm"
             href="?page={{ page_obj.previous_page_number }}{% if loc is not None %}&loc={{ loc }}{% endif %}">Previous</a>
        {% else %}
          <button class="btn btn-outline-secondary btn-sm" disabled>Previous</button>
        {% endif %}

        <span class="text-muted">
          Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
          <a class="btn btn-outline-secondary btn-sm"
             href="?page={{ page_obj.next_page_number }}{% if loc is not None %}&loc={{ loc }}{% endif %}">Next</a>
        {% else %}
          <button class="btn btn-outline-secondary btn-sm" disabled>Next</button>
        {% endif %}
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Timestamp</th>
            <th>Location</th>
            <th class="text-end">Temp (°F)</th>
            <th class="text-end">Humidity (%)</th>
            <th class="text-end">Dew Point (°F)</th>
            <th class="text-end">Battery (V)</th>
            <th class="text-end">Battery (%)</th>
            <th>Risk</th>
          </tr>
        </thead>

        <tbody>
          {% for m in page_obj.object_list %}
            {% if m.risk_level == "high" %}
              <tr class="table-danger">
            {% elif m.risk_level == "med" %}
              <tr class="table-warning">
            {% else %}
              <tr class="table-success">
            {% endif %}

              <td>{{ m.created_at|date:"Y-m-d H:i:s" }}</td>

              <td>
                <span class="badge text-bg-secondary">{{ m.location_label }}</span>
              </td>

              <td class="text-end">
                {% if m.temp_f is not None %}{{ m.temp_f|floatformat:1 }}{% else %}—{% endif %}
              </td>

              <td class="text-end">
                {% if m.hum_pct is not None %}{{ m.hum_pct|floatformat:1 }}{% else %}—{% endif %}
              </td>

              <td class="text-end">
                {% if m.dew_point_f is not None %}{{ m.dew_point_f|floatformat:1 }}{% else %}—{% endif %}
              </td>

              <td class="text-end">
                {% if m.batt_v is not None %}{{ m.batt_v|floatformat:2 }}{% else %}—{% endif %}
              </td>

              <td class="text-end">
                {% if m.batt_pct is not None %}{{ m.batt_pct }}{% else %}—{% endif %}
              </td>

              <td><strong>{{ m.risk_label }}</strong></td>
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

  </div>
</div>
{% endblock %}
